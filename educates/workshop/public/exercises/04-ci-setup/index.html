<!DOCTYPE html>
<html>

<head><script src="/workshop/content/livereload.js?mindelay=10&amp;v=2&amp;port=80&amp;path=workshop/content/livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="generator" content="Educates (hugo)">

<title>
  
  </title>

<link rel="stylesheet" href='/workshop/static/bootstrap/css/bootstrap.css'>
<link rel="stylesheet" href='/workshop/static/fontawesome/css/all.min.css'>

<link rel="stylesheet" href='/workshop/static/styles/educates.css'>
<link rel="stylesheet" href='/workshop/static/styles/educates-markdown.css'>
<link rel="stylesheet" href='/workshop/static/theme/workshop-instructions.css'>

<link rel="shortcut icon" href='/workshop/static/images/favicon.ico'>





</head>









































































































































































































<body data-google-tracking-id=''
  data-clarity-tracking-id=''
  data-amplitude-tracking-id='' data-workshop-name='educates-cli--cicd-cf0336d'
  data-session-namespace='educates-cli-w04-s001' data-workshop-namespace='educates-cli-w04'
  data-training-portal='educates-cli' data-ingress-domain='192.168.50.243.nip.io'
  data-ingress-protocol='http' data-ingress-port-suffix=''
  data-prev-page='exercises/03-ci' data-current-page='exercises/04-ci-setup'
  data-next-page='exercises/05-ci-makefile' data-page-format='markdown' data-code-fences='chroma'
  data-page-step='5' data-pages-total='9'>

  




<div class="modal fade" id="table-of-contents" tabindex="-1" role="dialog" aria-labelledby="table-of-contents-title"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="table-of-contents-title">CICD fundamentals</h5>
                <button class="btn btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="menu">
                    <li class="category">
                        <ul class="modules">
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/00-workshop-overview">1: Workshop Overview</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/01-flow">2: Flow</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/02-repository">3: Repository</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/03-ci">4: CI - Dagger</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page active">
                                <a href="/workshop/content/exercises/04-ci-setup">5: CI - Setup</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/05-ci-makefile">6: CI - Makefile</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/06-app">7: App</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/07-argocd">8: ArgoCD</a>
                            </li>
                            
                            
                            
                            
                            
                            
                            <li class="page">
                                <a href="/workshop/content/exercises/99-temp">9: Temp</a>
                            </li>
                            
                            
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" type="button" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="header page-navbar sticky-top bg-primary">
    <div class="row row-no-gutters">
        <div class="col-sm-12">
            <div class="btn-group btn-group-sm" role="group">
                <form action='/workshop/content/'>
                    <button class="btn btn-transparent" id="header-goto-home" type="submit" aria-label="home"><span
                            class="fas fa-home fa-inverse" aria-hidden="true"></span></button>
                </form>
            </div>
            <div class="btn-toolbar float-end" role="toolbar">
                <div class="btn-group btn-group-sm" role="group">
                    <form action="/workshop/content/exercises/03-ci">
                        <button class="btn btn-transparent" id="header-prev-page" type="submit"  aria-label="Prev"><span
                                class="fas fa-arrow-left fa-inverse" aria-hidden="true"></span></button>
                    </form>
                    <form>
                        <button class="btn btn-transparent" id="header-goto-toc" type="button" aria-label="TOC"
                            data-bs-toggle="modal" data-bs-target="#table-of-contents"><span class="fas fa-list fa-inverse"
                                aria-hidden="true"></span></button>
                    </form>
                    <form action="/workshop/content/exercises/05-ci-makefile">
                        <button class="btn btn-transparent" id="header-next-page" type="submit"  aria-label="Next"><span
                                class="fas fa-arrow-right fa-inverse" aria-hidden="true"></span></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


  




<div class="container-fluid main-content">
  <div class="row">
    <div class="col-sm-12">
      <section class="page-content" id="main">
        
        
        
        <h1 class="title" id="title">5: CI - Setup</h1>
        
        <div class="rendered-content">
          <p>Dagger cli is already installed in your enviroment.</p>
<p>The pipelines are all defines in the <code>dagger</code>directory under your <code>app</code> directory.</p>
<p>For this workshop, we won&rsquo;t setup and pipelines etc. We will just use the ones, that are already created.</p>
<p>Dagger works by creating functions we can call.</p>
<p>in <code>app/dagger/src/main/__init__.py</code> you will find the functions, written in Python.</p>
<p>The code looks like this :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Annotated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> dagger
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dagger <span style="color:#f92672">import</span> Doc, dag, function, object_type
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@object_type</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">App</span>:
</span></span><span style="display:flex;"><span>    image_url: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        src: Annotated[
</span></span><span style="display:flex;"><span>            dagger<span style="color:#f92672">.</span>Directory,
</span></span><span style="display:flex;"><span>            Doc(<span style="color:#e6db74">&#34;location of directory containing Dockerfile&#34;</span>),
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Build and publish image from existing Dockerfile&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        image_url <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            dag<span style="color:#f92672">.</span>container()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>with_directory(<span style="color:#e6db74">&#34;/src&#34;</span>, src)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>with_workdir(<span style="color:#e6db74">&#34;/src&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>directory(<span style="color:#e6db74">&#34;/src&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>docker_build()  <span style="color:#75715e"># build from Dockerfile</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>publish(<span style="color:#e6db74">&#34;ttl.sh/my-shiny-app&#34;</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> image_url
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update</span>(self, repo: str, branch: str, deploy_filepath: str, image_url: str, git_user: str, git_email: str, git_password: dagger<span style="color:#f92672">.</span>Secret, force_with_lease: bool) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Update deployment file, with image name and version&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>            dag<span style="color:#f92672">.</span>image_updater()
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>update(repo, branch, deploy_filepath, image_url, git_user, git_email, git_password, force_with_lease)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">deploy</span>(self, src: Annotated[
</span></span><span style="display:flex;"><span>            dagger<span style="color:#f92672">.</span>Directory,
</span></span><span style="display:flex;"><span>            Doc(<span style="color:#e6db74">&#34;location of directory containing Dockerfile&#34;</span>),
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            repo: str, 
</span></span><span style="display:flex;"><span>            branch: str,
</span></span><span style="display:flex;"><span>            deploy_filepath: str, 
</span></span><span style="display:flex;"><span>            image_url: str,
</span></span><span style="display:flex;"><span>            git_user: str, 
</span></span><span style="display:flex;"><span>            git_email: str, 
</span></span><span style="display:flex;"><span>            git_password: dagger<span style="color:#f92672">.</span>Secret, 
</span></span><span style="display:flex;"><span>            force_with_lease: bool) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        image_url <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span>(self<span style="color:#f92672">.</span>build(src))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>update(repo, branch, deploy_filepath, image_url, git_user, git_email, git_password, force_with_lease)
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create and push container image, and update deployment file, with the new image name and tag&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> image_url
</span></span></code></pre></div><p>There are 3 functions.</p>
<ul>
<li>
<p>build</p>
<p>Builds the container, and pushes it to the registry</p>
</li>
<li>
<p>update</p>
<p>Updated the deployment.yaml file, with the new name and tag of the container image.</p>
</li>
<li>
<p>deploy</p>
<p>Combines build and update to one job.</p>
</li>
</ul>

        </div>
        
        <div class="page-meta clearfix">
          <form action="/workshop/content/exercises/05-ci-makefile">
            <button class="btn btn-lg btn-primary float-end" id="next-page" type="submit" aria-label="continue">
              Continue </button>
          </form>
        </div>
        
      </section>
    </div>
  </div>
</div>
</section>


  <script src='/workshop/static/scripts/educates-bundle.js'></script>
<script src='/workshop/static/theme/workshop-instructions.js'></script>


</body>

</html>
